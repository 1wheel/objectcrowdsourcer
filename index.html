<html>
<head>
<title>CrowdTagger - Smile Version</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Bootstrap -->
<link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
<script src="js/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src="js/raphael-min.js"></script>

<script language='javascript'>


$( document ).ready(function() {
  // Handler for .ready() called.
  $('.emailentry').keyup(function(evt){
  	console.log("keyup");
  	console.log(evt);
  });


  // svg setup

  var offline = false;

  var testImage = "img/testImage.jpg"


  // Creates canvas 320 Ã— 200 at 10, 50
  var paper = Raphael("elemfortagging", 400, 600);

  var cachedObject = false;
  var cachedImage = false; 

  $(".clickfornext").click(function(){
  	if(cachedObject){
  		loadObject(cachedObject);
  		cachedObject = false;
  		getObjectToCache();
  	}else{

	  	console.log("request next");

	  	$.ajax({
	  		url: "/?action=nextObject",
	  		success : function(data, status){
	  			loadObject(data);
		  		getObjectToCache();
	  		},

	  		error : function(jqXHR, status, message){
	  			console.log("error ");
	  			console.log(status);
	  			console.log(message);
	  		}
	  	});
  	}
  });

  function loadObject(data){
 	console.log(data);
	currentObject = data;
	var theimage= data.image;
	if(offline){
		theimage = testImage;
	}
	var imgObj = new Image();
	console.log("clearing");
	paper.clear();
	imgObj.onload = function(){
		var result = ScaleImage(imgObj.width, imgObj.height, 800, 600, true);
		var image = paper.image(theimage, 0,0, result.width, result.height);
		image.click(function(evt){
			var x = evt.offsetX;
			var y = evt.offsetY;
			faceTapped(x,y);

		});
	}
	imgObj.src= theimage; 	



  }


  function getObjectToCache(){
  	$.ajax({
	  		url: "/?action=nextObject",
	  		success : function(data, status){
	  			cachedObject = data;

	  		},

	  		error : function(jqXHR, status, message){
	  			console.log("error ");
	  			console.log(status);
	  			console.log(message);
	  		}
	  	});
  }

  function faceTapped(x,y){
  		var outerCircle = paper.circle(x,y,11);
  		outerCircle.attr("stroke","#fff");

		var circle = paper.circle(x,y,10);
		circle.attr("stroke","#f00");
		circle.attr("stroke-width",1);
		circle.attr("fill", "#5f5");
		circle.attr("fill-opacity",".2");
		circle.click(function(evt2){
			console.log("circleclicked");
		});
		var newTX=0,newTY=0,fDx=0,fDy=0,tAddX,tAddY,reInitialize=false;

		circle.drag(
			function(dx,dy, x,y){
				tAddX=dx-fDx;
				tAddY=dy-fDy;
				fDx=dx;
				fDy=dy;
				if(reInitialize)
				{
					tAddX=0;
					fDx=0;
					tAddY=0;
					fDy=0;
					reInitialize=false;
				}
				else
				{
					newTX+=tAddX,newTY+=tAddY;
					circle.attr({transform: "t"+newTX+","+newTY});
					outerCircle.attr({transform: "t"+newTX+","+newTY});
				}
			 },
			 function(){

			 }, 
			 function (evt) {
				reInitialize=true;
				console.log(evt);
				var newX = evt.offsetX;
				var newY = evt.offsetY;
				// update position in db, etc
			  });
			

  }


  function ScaleImage(srcwidth, srcheight, targetwidth, targetheight, fLetterBox) {

    var result = { width: 0, height: 0, fScaleToTargetWidth: true };

    if ((srcwidth <= 0) || (srcheight <= 0) || (targetwidth <= 0) || (targetheight <= 0)) {
        return result;
    }

    // scale to the target width
    var scaleX1 = targetwidth;
    var scaleY1 = (srcheight * targetwidth) / srcwidth;

    // scale to the target height
    var scaleX2 = (srcwidth * targetheight) / srcheight;
    var scaleY2 = targetheight;

    // now figure out which one we should use
    var fScaleOnWidth = (scaleX2 > targetwidth);
    if (fScaleOnWidth) {
        fScaleOnWidth = fLetterBox;
    }
    else {
       fScaleOnWidth = !fLetterBox;
    }

    if (fScaleOnWidth) {
        result.width = Math.floor(scaleX1);
        result.height = Math.floor(scaleY1);
        result.fScaleToTargetWidth = true;
    }
    else {
        result.width = Math.floor(scaleX2);
        result.height = Math.floor(scaleY2);
        result.fScaleToTargetWidth = false;
    }
    result.targetleft = Math.floor((targetwidth - result.width) / 2);
    result.targettop = Math.floor((targetheight - result.height) / 2);

    return result;
  }

});

</script>
</head>
<body>

	<div class="container">
		<div class="row-fluid-banner">
			<div class="span6" align="left"><h1>CrowdTagger - Smiley Version</h1></div>
			<div class="span6" align="right">Enter Email to get started: <BR/><input type='text' class="emailentry" size=20 /></div>
		</div>
		<div class="row-fluid-banner">

			<div class="span12" ><span class="clickfornext">Next Object</span></div>
		</div>

		<div class="row-fluid-banner" >
			<div class="span7" id="elemfortagging"  width="400" height="600" style="border:1px solid black;"></div>
			<div class="span4" id="facemetadata">
				<h3>faces:</h3>
				<div class="facetags">
				</div>
			</div>
		</div>

	</div>



</body>
</html>