<html>
<head>
<title>CrowdTagger - Smile Version</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Bootstrap -->
<link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
<script src="js/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src="js/raphael-min.js"></script>

<script language='javascript'>


$( document ).ready(function() {



  var offline = false;

  var testImage = "img/testImage.jpg"


  // Creates canvas 320 Ã— 200 at 10, 50
  var paper = Raphael("elemfortagging", 400, 600);

  var cachedObject = false;
  var cachedImageObj = false;
  var cachedPaperImage = false; 
  var currentObject = false;
  var currentPaperImage = false;
  var currentObjectWidth = 1;
  var currentObjectHeight = 1;

  var first = true;

  var faces = [];

  var numFaces= 0;


  // Handler for .ready() called.
  $('.emailentry').keyup(function(evt){
  	updateClickForNext();
  });


  function updateClickForNext(){
	var value = $(".emailentry").val();
	console.log(value);
	if(value && value != ""){
		if(first){
			$(".clickfornext").text("Get Started!");
		}else{
			if(numFaces == 0){
				$(".clickfornext").text("No Smiles Here, Next!");
			}else{
				$(".clickfornext").text("Found all the Smiles, Next!");
			}
		}
	}else{
		$(".clickfornext").text("");
	}
	if(!first &&  !currentObject._id){
		$(".clickfornext").text("I think we're out of images...");

	}
  }

  // svg setup
  $(".clickfornext").click(function(){

  	first = false;
  	// first thing, update the CURERNT object in the DB with the new circle locations
  	/* array looks lke:
  	tags :
	{
		faces : [
			{
				center_pos : { value : [33,63], user : "donundeen@yahoo.com" },
				smile : {value : false, user : "ellen@ellen.com"},
			},
			{
				center_pos : { value : [33,63], user : "donundeen@yahoo.com" },
				smile : {value : false, user : "ellen@ellen.com"},
			}
		]
	}
	// but we're just assuming that every face is a smile now. so set smile to true, and set teh center_pos for each tag.
	// for now, we assume each object is being tagged for the first and only time.
	*/


	if(currentObject){
		var newFaces = [];
		var i = 0;
		$(faces).each(function(index, face){
			console.log(face);
			if(face != null){
				newFaces[i] = face;
				newFaces[i].center_pos.value[0]= face.center_pos.value[0] / currentObjectWidth;
				newFaces[i].center_pos.value[1] = face.center_pos.value[1] / currentObjectHeight;
				i++;
			}
		});
		console.log(newFaces);

		var data = {
			objectId : currentObject._id,
			rev  : currentObject._rev,
			faces : JSON.stringify(newFaces)
		};
		// send to server
		var action="updateObjectFaces";
		$.ajax({
			url : "/?action=" + action,
			data : data,
			contentType : 'application/json',
	  		success : function(data, status){
	  			console.log("success");
	  			console.log(data);
	  		},

	  		error : function(jqXHR, status, message){
	  			console.log("error ");
	  			console.log(status);
	  			console.log(message);
	  		}
		});

	}

	// unset current faces
	faces = [];
	numFaces = 0;
	// clear faces div
	$("#facetags").empty();

	$(".clickfornext").text("Waiting....");

  	if(cachedObject){
  		loadObject(cachedObject);
  		cachedObject = false;
  		getObjectToCache();
  	}else{

	  	console.log("request next");

	  	$.ajax({
	  		url: "/?action=nextObject",
	  		success : function(data, status){
	  			loadObject(data);
		  		getObjectToCache();
	  		},

	  		error : function(jqXHR, status, message){
	  			console.log("error ");
	  			console.log(status);
	  			console.log(message);
	  		}
	  	});
  	}
  });

  function loadObject(data){
 	console.log(data);
	currentObject = data;
	var theimage= data.image;

	if(offline){
		theimage = testImage;
	}
	var imgObj = new Image();
	console.log("clearing");
	if(currentPaperImage){}
	currentPaperImage.remove();
	currentPaperImage = null;
}
	imgObj.onload = function(){
		var result = ScaleImage(imgObj.width, imgObj.height, 400, 600, true);
		currentPaperImage = paper.image(theimage, 0,0, result.width, result.height);
		currentObjectWidth = result.width;
		currentObjectHeight = result.height;
		image.click(function(evt){
			var x = evt.offsetX;
			var y = evt.offsetY;
			faceTapped(x,y);

		});
		updateClickForNext();
	}
	imgObj.src= theimage; 	

  }


  function getObjectToCache(){
  	$.ajax({
	  		url: "/?action=nextObject",
	  		success : function(data, status){
	  			cachedObject = data;
	  		},

	  		error : function(jqXHR, status, message){
	  			console.log("error ");
	  			console.log(status);
	  			console.log(message);
	  		}
	  	});
  }

  function faceTapped(x,y){
  		var outerCircle = paper.circle(x,y,11);
  		outerCircle.attr("stroke","#fff");

		var circle = paper.circle(x,y,10);
		circle.attr("stroke","#f00");
		circle.attr("stroke-width",1);
		circle.attr("fill", "#5f5");
		circle.attr("fill-opacity",".2");
		circle.click(function(evt2){
			console.log("circleclicked");
		});
		var newTX=0,newTY=0,fDx=0,fDy=0,tAddX,tAddY,reInitialize=false;

		var index= faces.length;
		var deletespan = setFacePos(index, x,y);

		$(deletespan).click(function(){
			console.log("deleteclicked");
			circle.remove();
			outerCircle.remove();
		})

		circle.drag(
			function(dx,dy, x,y){
				tAddX=dx-fDx;
				tAddY=dy-fDy;
				fDx=dx;
				fDy=dy;
				if(reInitialize)
				{
					tAddX=0;
					fDx=0;
					tAddY=0;
					fDy=0;
					reInitialize=false;
				}
				else
				{
					newTX+=tAddX,newTY+=tAddY;
					circle.attr({transform: "t"+newTX+","+newTY});
					outerCircle.attr({transform: "t"+newTX+","+newTY});
				}
			 },
			 function(){

			 }, 
			 function (evt) {
			 	console.log("dragover");
				reInitialize=true;
				console.log(evt);
				var newX = evt.offsetX;
				var newY = evt.offsetY;
				// update position in html, interal array, etc
				setFacePos(index,newX, newY);

			  });
			

  }


  function setFacePos(index, x, y){
  	/*
		faces : [
			{
				center_pos : { value : [33,63], user : "donundeen@yahoo.com" },
				smile : {value : false, user : "ellen@ellen.com"},
			},
			{
				center_pos : { value : [33,63], user : "donundeen@yahoo.com" },
				smile : {value : false, user : "ellen@ellen.com"},
			}
		]
		*/
	var id = "faces"+ index;
	var email = $("#emailentry").val();
	if(!faces[index]){
		console.log("Adding face");
		faces[index] = {};
		numFaces++;
		$("#facetags").append("<div id='"+id+"' class='facetag'>smile at: <span class='x'>"+x+"</span>,<span class='y'>"+y+"</span><span class='email' style='display: none;'>"+email+"</span><span class='deleteface'>delete</span></div>");
	}else{

	}
	var xpath = "#facetags #" + id +" .x";
	var ypath = "#facetags #" + id +" .y";
	$(xpath).text(x);
	$(ypath).text(y);

	faces[index].center_pos = { value : [x,y], user : email};

	$("#facetags #"+id + " .deleteface").click(function(){
		// remove from data
		faces[index] = null;
		console.log("removing fromdiv");
		$("#facetags #" + id).remove();
		console.log(faces);
		numFaces--;
		updateClickForNext();
	});
	updateClickForNext();
	return $("#facetags #"+id + " .deleteface");
  }

  function ScaleImage(srcwidth, srcheight, targetwidth, targetheight, fLetterBox) {

    var result = { width: 0, height: 0, fScaleToTargetWidth: true };

    if ((srcwidth <= 0) || (srcheight <= 0) || (targetwidth <= 0) || (targetheight <= 0)) {
        return result;
    }

    // scale to the target width
    var scaleX1 = targetwidth;
    var scaleY1 = (srcheight * targetwidth) / srcwidth;

    // scale to the target height
    var scaleX2 = (srcwidth * targetheight) / srcheight;
    var scaleY2 = targetheight;

    // now figure out which one we should use
    var fScaleOnWidth = (scaleX2 > targetwidth);
    if (fScaleOnWidth) {
        fScaleOnWidth = fLetterBox;
    }
    else {
       fScaleOnWidth = !fLetterBox;
    }

    if (fScaleOnWidth) {
        result.width = Math.floor(scaleX1);
        result.height = Math.floor(scaleY1);
        result.fScaleToTargetWidth = true;
    }
    else {
        result.width = Math.floor(scaleX2);
        result.height = Math.floor(scaleY2);
        result.fScaleToTargetWidth = false;
    }
    result.targetleft = Math.floor((targetwidth - result.width) / 2);
    result.targettop = Math.floor((targetheight - result.height) / 2);

    return result;
  }

});

</script>
</head>
<body>

	<div class="container">
		<div class="row-fluid-banner">
			<div class="span6" align="left"><h1>CrowdTagger - Smiley Version</h1></div>
			<div class="span5" align="right">Enter Email to get started: <BR/><input type='text' id="emailentry" class="emailentry" size=20 /></div>
		</div>

		<div class="row-fluid-banner" >
			<div class="span6" id="elemfortagging"  width="400" height="600" style="border:1px solid black;"></div>
			<div class="span4" id="facemetadata">
			<div><h3 class="clickfornext"></h3></div>
				<h3>faces:</h3>
				<div class="facetags" id="facetags">
				</div>

			</div>
		</div>

	</div>



</body>
</html>